{% extends "base.html" %}
{% load static %}
{% block content %}

    <div id="main-city-data">
        {% autoescape off %}
            {{ color_key }}
        {% endautoescape %}

        <div id="overall-aqi">
            <p>
                {% if city.max_aqi %}
                    {{ city.max_aqi}}
                {% else %}
                    {# Add non-breaking space to maintain vertical space?  #}
                     &nbsp;
                {% endif %}
            </p>
        </div>

        <form action="." method="post">
            {% csrf_token %}
            {{ form }}
            <input type="submit" value="OK">
        </form>

        {% if no_result %}
            <p id="no-result">{{ no_result }}</p>
        {% elif not city %}
            <p>Enter a zip code.</p>
        {% else %}
            <p id="reporting-area">{{ city.reporting_area }}</p>
            <ul id="full-report">
            {% for x in city.full_report %}
                <li><span>{{ x.pollutant }}:</span> {{ x.pollutant_aqi }} ({{ x.cat_name }})</li>
            {% endfor %}
            </ul>

            <div id="historical">
            {% if historical_report != None %}
                <div class="chart">
                <!-- Historical data visualization -->
                {{ historical_report | json_script:"historical_json" }}
                </div>
            {% else %}
                <p>Historical data not available for <strong>{{ city.zip_code }}</strong>.</p>
            {% endif %}
            </div>


        {% endif %}
    </div>

    <div>
        <ul id="populated-cities">
            {% for x in populated_city_reports %}
                <li class="cat{{ x.max_cat }}"><a class="cat{{ x.max_cat }}" href="/{{ x.zip_code }}">{{ x.reporting_area }} <span>{{ x.max_aqi }}</span></a> </li>
            {% endfor %}
        </ul>
    </div>
{% endblock content %}


{% block footer %}
    <!-- Monitor zip code input -->
    <script>
        (function() {
            const form_input = document.getElementById("id_zip_code");
            const form = document.getElementsByTagName("form")[0];

            form_input.focus();

            let regex = new RegExp("^[0-9]+$");

            // Submit form if input changes
            // and there are 5 numbers
            form_input.addEventListener("input", function(event) {
               if (this.value.length == 5 && regex.test(this.value)) {
                   form.submit()
               }
            });

           // Block non-numeric characters
           form_input.addEventListener("keypress", function(event) {
               if (!regex.test(event.key)) {
                   event.preventDefault();
                   return false;
               }
           });
        })();
    </script>


    <!-- Make color key clickable -->
    <script>
        (function() {
            const color_key = document.getElementById("color-key");
            let initial_pos = "-7em";
            color_key.style.left = initial_pos;

            color_key.addEventListener("click", function() {
                let current_pos = color_key.style.left;

                if (current_pos == "0px") {
                    color_key.style.left = initial_pos;
                } else {
                    color_key.style.left = "0px";
                }
            })
        })();
    </script>

    <!-- Add historical chart if data is available -->
    {% if historical_report != None %}
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script src="{% static 'js/historical.js' %}"></script>
    {% endif %}
{% endblock footer %}
